<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Files</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      padding: 48px;
    }

    body.dark {
      background-color: #0c0c0c;
      color: white;
    }

    a {
      color: lightskyblue;
      text-decoration: underline;
      padding: 8px;
      border: 1px solid lightskyblue;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  
  <img src="./assets/Screenshot 2022-09-17 at 11.58.55 AM.png" style="width: 100%; height: 100px; border-radius: 8px; object-fit: cover;" alt="">
  <h1><b>Re-Cloud: Private File Hosting</b></h1>
  <p>Created by Rohin</p>
  <br>
  <h3 id="status">Status: n/a</h3>
  <div id="downloadButtons">
  </div>
  <br><br>
  <input type="file" name="" id="inputElement">

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js'
    import { getStorage, ref, uploadBytesResumable } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-storage.js'
    import { getFirestore, addDoc, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js'

    // Initialize
    const firebaseConfig = {
      apiKey: "AIzaSyCNuiHb0Pp-ccdqrkUrpICvFAM6SiJLBqY",
      authDomain: "re-app0.firebaseapp.com",
      projectId: "re-app0",
      storageBucket: "re-app0.appspot.com",
      messagingSenderId: "683468001343",
      appId: "1:683468001343:web:5aabcd6a486ec426cc288a"
    };
    
    const app = initializeApp(firebaseConfig);
    const storageInstance = getStorage(app);
    const db = getFirestore(app);

    window.handleUpload = (file) => {
      const date = `${new Date().getTime()}${Math.random().toString(36).substring(3)}`;
      const storageRef = ref(storageInstance, 'files/' + date + file.name);
      // Upload file with progress bar
      const uploadTask = uploadBytesResumable(storageRef, file);
      uploadTask.on('state_changed', (snapshot) => {
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        document.getElementById('status').innerHTML = `Status: Uploading (${progress.toFixed(2)}%)`;
      }, (error) => {
          document.getElementById('status').innerHTML = `Status: Failure`;
          alert('Did not complete')
        }, 
        async () => {
          document.getElementById('status').innerHTML = `Status: Uploaded`;

          // Get the download URL
          const downloadUrL = `https://firebasestorage.googleapis.com/v0/b/re-app0.appspot.com/o/files%2F${date}${file.name.replaceAll(` `, `%20`)}?alt=media`

          const doc = await addDoc(collection(db, `shortenedLinks`), {
            url: downloadUrL,
            numUsed: 0,
            lastUsed: serverTimestamp(),
            createdAt: serverTimestamp(),
          });

          const trackedLink = `https://r0h.in/re?u=${doc.id}`;

          document.getElementById('downloadButtons').innerHTML = `
            <a onclick="copyText('${downloadUrL}')">Copy direct link</a>
            <a onclick="copyText('${trackedLink}')">Copy tracked link</a>
          `
        }
      );
    }

    window.copyText = (text) => {
      navigator.clipboard.writeText(text);
      document.getElementById('status').innerHTML = `Status: Copied!`;
    }

    document.getElementById('inputElement').addEventListener('change', (e) => {
      const file = e.target.files[0];
      handleUpload(file);
    })
  </script>

  <script>
    // On paste
    document.addEventListener('paste', (event) => {
      const items = event.clipboardData.items;
      const item = items[0];
      if (item.kind === 'file') {
        const file = item.getAsFile();
        console.log(file)
        handleUpload(file);
      }
    });
  </script>

  <script>
    // Dark mode listener
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      document.body.classList.toggle('dark', e.matches);
    });

    // Dark mode initial state
    document.body.classList.toggle('dark', window.matchMedia('(prefers-color-scheme: dark)').matches);
  </script>



</body>
</html>